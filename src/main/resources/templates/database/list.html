<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Mysqlè¿æ¥ç®¡ç†</title>
    <link rel="stylesheet" href="/layui/css/layui.css" media="all"/>
    <link rel="stylesheet" href="/css/global.css" media="all">
    <link rel="stylesheet" href="/plugins/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/table.css"/>
</head>

<body>
<div class="admin-main">

    <blockquote class="layui-elem-quote">
        <div class="layui-form">
            <div class="layui-input-inline">
                <label class="layui-label">æ•°æ®åº“åç§°ï¼š</label>
                <div class="layui-inline" >
                    <input type="text" name="name" id="NAME" placeholder="è¯·è¾“å…¥åç§°" autocomplete="off" class="layui-input">
                </div>
            </div>

            <div class="layui-input-inline">
                <label class="layui-label">çŠ¶æ€ï¼š</label>
                <div class="layui-inline" >
                    <select name="status" id="STATUS" style="padding: 0px 20px;">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="0">æœªå¯ç”¨</option>
                        <option value="1">å·²å¯ç”¨</option>
                    </select>
                </div>
            </div>

            <div class="layui-input-inline">
                <label class="layui-label">åˆ›å»ºæ—¥æœŸï¼š</label>
                <div class="layui-inline">
                    <div class="layui-input-inline" >
                        <input class="layui-input" name="startTime" placeholder="å¼€å§‹æ—¥æœŸ" id="LAY_demorange_s" />
                    </div>
                    <div class="layui-input-inline">
                        &nbsp;-&nbsp;
                    </div>
                    <div class="layui-input-inline" >
                        <input class="layui-input" name="endTime" placeholder="æˆªæ­¢æ—¥æœŸ" id="LAY_demorange_e" />
                    </div>
                </div>
            </div>


            <div class="layui-input-inline" style="margin-left: 2%">
                <button class="layui-btn" data-type="reload" id="search">æœç´¢</button>
                <button type="reset" class="layui-btn layui-btn-primary" id="reset">é‡ç½®</button>
                <button class="layui-btn" data-type="reload" id="add"><i class="layui-icon">&#xe608;</i>æ·»åŠ </button>
            </div>

        </div>
    </blockquote>

    <fieldset class="layui-elem-field">
        <legend>æ•°æ®åº“åˆ—è¡¨</legend>
        <div class="layui-field-box layui-form">
            <table class="layui-hide" id="dataTable" lay-filter="barDemo"></table>
            <script type="text/html" id="dataBaseId">
                <a href="#" class="layui-table-link" onclick="queryDetail('{{d.id}}');">{{ d.dataSourceName }}</a>
            </script>
            <script type="text/html" id="operationDataBase">
                <a href="#" class="layui-btn layui-btn-xs"  onclick="update('{{d.id}}');">ç¼–è¾‘</a>
                {{# if(d.isEnabled == 0){ }}
                    <a href="#" class="layui-btn layui-btn-xs"  onclick="startUsing('{{d.id}}');">å¯ç”¨</a>
                {{# } else if(d.isEnabled == 1) { }}
                    <a href="#" class="layui-btn layui-btn-xs layui-btn-warm"  onclick="forbidden('{{d.id}}');">ç¦ç”¨</a>
                {{# } else { }}
                    <a href="#" class="layui-btn layui-btn-xs layui-btn-disabled">ğŸ˜¨</a>
                {{# } }}
                <a href="#" class="layui-btn layui-btn-xs layui-btn-danger" onclick="deleteData('{{d.id}}')">åˆ é™¤</a>
            </script>
        </div>
    </fieldset>
    <div class="admin-table-page">
        <div id="paged" class="page">
        </div>
    </div>

</div>



<!--æ·»åŠ é¡µé¢æ¨¡æ¿-->
<template id="addTemplate" hidden>
    <div class="admin-main">

        <!--<blockquote class="layui-elem-quote">-->
            <div class="layui-form" lay-filter="add-form" id="add-form">
                <div class="layui-form-item">
                    <label class="layui-form-label">æ•°æ®åº“åç§°</label>
                    <div class="layui-input-block">
                        <input type="text" name="dataSourceName" lay-verify="required" placeholder="è¯·è¾“å…¥æ•°æ®åº“åç§°" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">æ•°æ®åº“url</label>
                    <div class="layui-input-block">
                        <input type="text" name="url" lay-verify="required" placeholder="è¯·è¾“å…¥æ•°æ®åº“url" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">æ•°æ®åº“ç«¯å£</label>
                    <div class="layui-input-block">
                        <input type="text" name="port" lay-verify="number" placeholder="è¯·è¾“å…¥æ•°æ®åº“ç«¯å£" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">æ•°æ®åº“è´¦å·</label>
                    <div class="layui-input-block">
                        <input type="text" name="dataSourceAccount" lay-verify="required" placeholder="è¯·è¾“å…¥æ•°æ®åº“è´¦å·" autocomplete="off" class="layui-input">
                    </div>
                </div>


                <div class="layui-form-item">
                    <label class="layui-form-label">æ•°æ®åº“å¯†ç </label>
                    <div class="layui-input-block">
                        <input type="text" name="dataSourcePwd" lay-verify="required" placeholder="è¯·è¾“å…¥æ•°æ®åº“å¯†ç " autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">ç¼–ç </label>
                    <div class="layui-input-block">
                        <input type="radio" name="coding" value="0" title="utf-8" checked>
                        <input type="radio" name="coding" value="1" title="gbk" >
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">æ˜¯å¦å¯ç”¨</label>
                    <div class="layui-input-block">
                        <input type="radio" name="isEnabled" value="1" title="æ˜¯" checked>
                        <input type="radio" name="isEnabled" value="0" title="å¦" >
                    </div>
                </div>

            </div>
       <!-- </blockquote>-->
    </div>
</template>




<script type="text/javascript" src="/plugins/layui/layui.js"></script>
<script type="text/javascript" src="/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="/js/utils.js"></script>
<script>
    layui.config({
        base: '/js/'
    });

    $(function () {
        //è®¾ç½®ajaxè¯·æ±‚å®Œæˆåè¿è¡Œçš„å‡½æ•°
        $.ajaxSetup({
            complete:function(XMLHttpRequest){
                if("REDIRECT" == XMLHttpRequest.getResponseHeader("REDIRECT")){ //è‹¥HEADERä¸­å«æœ‰REDIRECTè¯´æ˜åç«¯æƒ³é‡å®šå‘ï¼Œ
                    var win = window;
                    while(win != win.top){
                        win = win.top;
                    }
                    layer.msg('ç™»å½•å¤±æ•ˆï¼Œå°†ä¸ºæ‚¨è·³è½¬åˆ°ç™»å½•é¡µé‡æ–°ç™»å½•',
                        {
                            icon: 5,
                            time: 3000
                        }, function(){
                            win.location.href = XMLHttpRequest.getResponseHeader("CONTENTPATH");//å°†åç«¯é‡å®šå‘çš„åœ°å€å–å‡ºæ¥,ä½¿ç”¨win.location.hrefå»å®ç°é‡å®šå‘çš„è¦æ±‚
                        });
                }
            }
        });
    });

    layui.use([ 'form','laydate','laypage', 'table','util'], function () {


        var laydate = layui.laydate //æ—¥æœŸ
            ,$ = layui.jquery
            ,laypage = layui.laypage //åˆ†é¡µ
            ,table = layui.table //è¡¨æ ¼
            ,upload = layui.upload //ä¸Šä¼ 
            ,element = layui.element
            ,form = layui.form
            ,util = layui.util;//å…ƒç´ æ“ä½œ

            //è®¾ç½®ajaxè¯·æ±‚å®Œæˆåè¿è¡Œçš„å‡½æ•°
            $.ajaxSetup({
                complete:function(XMLHttpRequest){
                    if("REDIRECT" == XMLHttpRequest.getResponseHeader("REDIRECT")){ //è‹¥HEADERä¸­å«æœ‰REDIRECTè¯´æ˜åç«¯æƒ³é‡å®šå‘ï¼Œ
                        var win = window;
                        while(win != win.top){
                            win = win.top;
                        }
                        layer.msg('ç™»å½•å¤±æ•ˆï¼Œå°†ä¸ºæ‚¨è·³è½¬åˆ°ç™»å½•é¡µé‡æ–°ç™»å½•',
                            {
                                icon: 5,
                                time: 3000
                            }, function(){
                                win.location.href = XMLHttpRequest.getResponseHeader("CONTENTPATH");//å°†åç«¯é‡å®šå‘çš„åœ°å€å–å‡ºæ¥,ä½¿ç”¨win.location.hrefå»å®ç°é‡å®šå‘çš„è¦æ±‚
                            });
                    }
                }
            });




        var start = {
            max: '2099-06-16 23:59:59',
            format: 'yyyy-MM-dd HH:mm:ss',
            type: 'datetime',
            show: true
            ,done: function(value){
                end.min = value; //å¼€å§‹æ—¥é€‰å¥½åï¼Œé‡ç½®ç»“æŸæ—¥çš„æœ€å°æ—¥æœŸ
                end.start = value //å°†ç»“æŸæ—¥çš„åˆå§‹å€¼è®¾å®šä¸ºå¼€å§‹æ—¥
            }
        };
        var end = {
            max: '2099-06-16 23:59:59',
            format: 'yyyy-MM-dd HH:mm:ss',
            type: 'datetime',
            show: true
            ,done: function(value){
                start.max = value; //ç»“æŸæ—¥é€‰å¥½åï¼Œé‡ç½®å¼€å§‹æ—¥çš„æœ€å¤§æ—¥æœŸ
            }
        };

        $('#LAY_demorange_s').on('click',function (){
            start.elem = this;
            start.closeStop = this
            laydate.render(start);
        });
        $('#LAY_demorange_e').on('click',function (){
            end.elem = this;
            end.closeStop = this
            laydate.render(end);
        });

        $('#reset').on('click', function () {
            NAME.value = "";
            LAY_demorange_s.value = "";
            STATUS.value = "";
            LAY_demorange_e.value = "";
            start.max =  '2099-06-16 23:59:59';
            end.min = '1977-06-16 23:59:59';
            end.start = '1977-06-16 23:59:59';
            form.render();
        });

        var tableData = {
            elem: '#dataTable'
            ,url: '/api/database/dataBaseList' //æ•°æ®æ¥å£
            ,page: true //å¼€å¯åˆ†é¡µ
            ,where: {
                name: NAME.value,
                startTime: LAY_demorange_s.value,
                endTime: LAY_demorange_e.value,
                status: STATUS.value
            }
            ,cols: [[ //è¡¨å¤´
                { title: 'æ•°æ®åº“åç§°', templet: '#dataBaseId'}
                ,{field: 'url', title: 'æ•°æ®åº“url'}
                ,{field: 'port', title: 'æ•°æ®åº“ç«¯å£'}
                /* ,{field: 'account', title: 'æ•°æ®åº“è´¦å·'}
                ,{field: 'pwd', title: 'æ•°æ®åº“å¯†ç '}*/
                ,{field: 'coding', title: 'ç¼–ç æ ¼å¼',templet:function(d){
                        if(d.coding == 0){
                            return "UTF-8";
                        }else if(d.coding == 1){
                            return "GBK";
                        }else{
                            return "æœªçŸ¥";
                        }
                    }}
                ,{field: 'isEnabled', title: 'çŠ¶æ€',templet:function(d){
                        if(d.isEnabled == 0){
                            return "<label style='color: red'>æœªå¯ç”¨</label>";
                        }else if(d.isEnabled == 1){
                            return "<label style='color: green'>å·²å¯ç”¨</label>";
                        }else{
                            return "<label style='color: yellow'>æœªçŸ¥</label>";
                        }
                    }}
                ,{field: 'createTime', title: 'åˆ›å»ºæ—¶é—´',templet:function (d) {
                        return util.toDateString(d.createTime,'yyyy-MM-dd HH:mm:ss');
                    }}
                ,{field: 'createUser', title: 'åˆ›å»ºäºº'}
                ,{fixed: 'right',title: 'æ“ä½œ', align:'left', minWidth: 200,toolbar: '#operationDataBase'}
            ]]
        }

        table.render(tableData);

        $('#search').on('click', function () {
            tableData.where = {
                name: NAME.value,
                startTime: LAY_demorange_s.value,
                endTime: LAY_demorange_e.value,
                status: STATUS.value
            }
            table.render(tableData);
            return false;
        });

        $('#add').on('click', function () {
            var template = $('#addTemplate').html();
            layer.open({
                type: 1,
                title: 'æ–°å¢æ•°æ®åº“',
                content: template,
                btn: ['ç¡®å®š', 'å–æ¶ˆ'],
                // btnAlign: 'c',//æŒ‰é’®å±…ä¸­
                // shade: false, //é®ç½©
                offset: 'auto',
                area: ['600px', '450px'],
                // area: 'auto',
                maxmin: true,
                yes: function(index) {
                    if($("#add-form").find("input[name='dataSourceName']").val().length == 0){
                        layer.tips("è¯·è¾“å…¥æ•°æ®åº“åç§°",$("#add-form").find("input[name='dataSourceName']"));
                        return;
                    }
                    if($("#add-form").find("input[name='url']").val().length == 0){
                        layer.tips("è¯·è¾“å…¥æ•°æ®åº“url",$("#add-form").find("input[name='url']"));
                        return;
                    }
                    if($("#add-form").find("input[name='port']").val().length == 0){
                        layer.tips("è¯·è¾“å…¥æ•°æ®åº“ç«¯å£",$("#add-form").find("input[name='port']"));
                        return;
                    }
                    if($("#add-form").find("input[name='dataSourceAccount']").val().length == 0){
                        layer.tips("è¯·è¾“å…¥æ•°æ®åº“è´¦å·",$("#add-form").find("input[name='dataSourceAccount']"));
                        return;
                    }
                    if($("#add-form").find("input[name='dataSourcePwd']").val().length == 0){
                        layer.tips("è¯·è¾“å…¥æ•°æ®åº“å¯†ç ",$("#add-form").find("input[name='dataSourcePwd']"));
                        return;
                    }
                    $.ajax({
                        type: "POST",
                        contentType: "application/json;charset=UTF-8",
                        url: "/api/database/addDataBase",
                        dateType:"json",
                        data: JSON.stringify({
                            dataSourceName:$("#add-form").find("input[name='dataSourceName']").val(),
                            url: $("#add-form").find("input[name='url']").val(),
                            port: $("#add-form").find("input[name='port']").val(),
                            account: $("#add-form").find("input[name='dataSourceAccount']").val(),
                            pwd: $("#add-form").find("input[name='dataSourcePwd']").val(),
                            coding: $("#add-form").find("input[name='coding']:checked").val(),
                            isEnabled: $("#add-form").find("input[name='isEnabled']:checked").val()
                        }),
                        success : function(data) {
                            if (0 == data.code){
                                layer.close(index);
                                layer.msg('æ·»åŠ æˆåŠŸ',
                                    {
                                        icon: 1,
                                        time: 2000 //2ç§’å…³é—­ï¼ˆå¦‚æœä¸é…ç½®ï¼Œé»˜è®¤æ˜¯3ç§’ï¼‰
                                    }, function(){
                                        table.render(tableData);
                                });
                            }else {
                                layer.msg(data.msg,
                                    {
                                        icon: 2,
                                        time: 3000
                                    });
                            }
                        },
                        error:function(){
                            layer.close(index);
                            layer.msg('äº²ï¼Œè¯·æ±‚å¼‚å¸¸äº†â€¦â€¦',
                                {
                                    icon: 5,
                                    time: 2000 //2ç§’å…³é—­ï¼ˆå¦‚æœä¸é…ç½®ï¼Œé»˜è®¤æ˜¯3ç§’ï¼‰
                                }, function(){
                                    table.render(tableData);
                                });
                        }
                    });
                },
                success: function(layero, index) {
                    //å¼¹å‡ºçª—å£æˆåŠŸåæ¸²æŸ“è¡¨å•
                    form.render(null,'add-form');//æ›´æ–°lay-filter="add-form"æ‰€åœ¨å®¹å™¨å†…çš„å…¨éƒ¨è¡¨å•çŠ¶æ€
                }
            });


        });


        window.renderTableData = function () {//å¤–éƒ¨è°ƒç”¨
            table.render(tableData);
        }


    });

    //æŸ¥è¯¢è¯¦æƒ…
    function queryDetail(id) {
        layui.use('form', function(){
            var form = layui.form;
            $.get("/api/database/queryDetailById",{id:id,type:1},function (data) {
                layer.open({
                    type: 1,
                    title: 'æ•°æ®åº“é…ç½®è¯¦æƒ…',
                    content: data,
                    btn: ['ç¡®å®š'],
                    btnAlign: 'c',//æŒ‰é’®å±…ä¸­
                    // shade: false, //é®ç½©
                    offset: ['100px', '30%'],
                    area: ['600px', '450px'],
                    // zIndex: 19950924,
                    maxmin: true,
                    yes: function(index) {
                        layer.close(index);
                    },
                    success: function(layero, index) {
                        form.render();
                    }
                });
            })
        });

    };

    //ä¿®æ”¹
    function update(id) {
        layui.use('form', function(){
            var form = layui.form;
            $.get("/api/database/queryDetailById",{id:id,type:2},function (data) {
                layer.open({
                    type: 1,
                    title: 'ä¿®æ”¹æ•°æ®åº“é…ç½®',
                    content: data,
                    btn: ['ä¿®æ”¹','å–æ¶ˆ'],
                    // btnAlign: 'c',//æŒ‰é’®å±…ä¸­
                    // shade: false, //é®ç½©
                    offset: ['100px', '30%'],
                    area: ['600px', '450px'],
                    // zIndex: 19950924,
                    maxmin: true,
                    yes: function(index) {
                        //è§¦å‘è¡¨å•çš„æäº¤äº‹ä»¶
                        $('form.layui-form').find('button[lay-filter=update]').click();
                    },
                    success: function(layero, index) {
                        form.render();
                        form.on('submit(update)', function(data) {
                            $.ajax({
                                type:"post",
                                url:"/api/database/updateDataBase",
                                dateType:"json",
                                data:data.field,
                                success:function(result){
                                    if (0 == result.code){
                                        layer.close(index);
                                        layer.msg('ä¿®æ”¹æˆåŠŸ',
                                            {
                                                icon: 1,
                                                time: 2000
                                            });
                                        renderTableData();//åˆ·æ–°è¡¨å•
                                    }else {
                                        layer.msg(result.msg,
                                            {
                                                icon: 2,
                                                time: 2000
                                            });
                                    }
                                }, error: function () {
                                    layer.msg('äº²ï¼Œè¯·æ±‚å¼‚å¸¸äº†â€¦â€¦', {
                                        icon: 5,
                                        time: 2000
                                    });
                                }
                            });
                            return false; //é˜»æ­¢è¡¨å•è·³è½¬ã€‚å¦‚æœéœ€è¦è¡¨å•è·³è½¬ï¼Œå»æ‰è¿™æ®µå³å¯ã€‚
                        });
                    }
                });
            })
        });
    }


    //å¯ç”¨
    function startUsing(id) {
        layer.confirm('ç¡®å®šå¯ç”¨å—ï¼Ÿ', {icon: 3, title:'æç¤º'}, function(index){
            $.ajax({
                type:"get",
                url:"/api/database/startUsing",
                dateType:"json",
                data:{id:id},
                success:function(result){
                    renderTableData();//åˆ·æ–°è¡¨å•
                    if (0 == result.code){
                        layer.msg('å¯ç”¨æˆåŠŸ',
                            {
                                icon: 1,
                                time: 2000
                            });
                    }else {
                        layer.msg('å¯ç”¨å¤±è´¥',
                            {
                                icon: 2,
                                time: 2000
                            });
                    }
                }, error: function () {
                    layer.msg('äº²ï¼Œè¯·æ±‚å¼‚å¸¸äº†â€¦â€¦', {
                        icon: 5,
                        time: 2000
                    });
                }
            });
            layer.close(index);
            return false; //é˜»æ­¢è¡¨å•è·³è½¬ã€‚å¦‚æœéœ€è¦è¡¨å•è·³è½¬ï¼Œå»æ‰è¿™æ®µå³å¯ã€‚
        });
    }


    //ç¦ç”¨
    function forbidden(id) {
        layer.confirm('ç¡®å®šç¦ç”¨å—ï¼Ÿ', {icon: 3, title:'æç¤º'}, function(index){
            $.ajax({
                type:"get",
                url:"/api/database/forbidden",
                dateType:"json",
                data:{id:id},
                success:function(result){
                    renderTableData();//åˆ·æ–°è¡¨å•
                    if (0 == result.code){
                        layer.msg('ç¦ç”¨æˆåŠŸ',
                            {
                                icon: 1,
                                time: 2000
                            });
                    }else {
                        layer.msg('ç¦ç”¨å¤±è´¥',
                            {
                                icon: 2,
                                time: 2000
                            });
                    }
                }, error: function () {
                    layer.msg('äº²ï¼Œè¯·æ±‚å¼‚å¸¸äº†â€¦â€¦', {
                        icon: 5,
                        time: 2000
                    });
                }
            });
            layer.close(index);
            return false; //é˜»æ­¢è¡¨å•è·³è½¬ã€‚å¦‚æœéœ€è¦è¡¨å•è·³è½¬ï¼Œå»æ‰è¿™æ®µå³å¯ã€‚
        });
    }


    //åˆ é™¤
    function deleteData(id) {
        layer.confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ', {icon: 3, title:'æç¤º'}, function(index){
            $.ajax({
                type:"get",
                url:"/api/database/delete",
                dateType:"json",
                data:{id:id},
                success:function(result){
                    renderTableData();//åˆ·æ–°è¡¨å•
                    if (0 == result.code){
                        layer.msg('åˆ é™¤æˆåŠŸ',
                            {
                                icon: 1,
                                time: 2000
                            });
                    }else {
                        layer.msg('åˆ é™¤å¤±è´¥',
                            {
                                icon: 2,
                                time: 2000
                            });
                    }
                }, error: function () {
                    layer.msg('äº²ï¼Œè¯·æ±‚å¼‚å¸¸äº†â€¦â€¦', {
                        icon: 5,
                        time: 2000
                    });
                }
            });
            layer.close(index);
            return false; //é˜»æ­¢è¡¨å•è·³è½¬ã€‚å¦‚æœéœ€è¦è¡¨å•è·³è½¬ï¼Œå»æ‰è¿™æ®µå³å¯ã€‚
        });
    }


</script>
</body>

</html>